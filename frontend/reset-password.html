<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Restablecer contraseña - MindConnectAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
            background: linear-gradient(135deg, #FFF0F5 0%, #F0E6FF 50%, #E6F3FF 100%); 
            min-height:100vh; display:flex; align-items:center; 
            justify-content:center;padding:24px 
        }
        .card { 
            background:#fff; 
            padding:24px; border-radius:12px; 
            width:100%; 
            max-width:480px; 
            box-shadow:0 8px 30px rgba(155,89,182,0.15);
            border: 1px solid rgba(155,89,182,0.1);
        }
        input:focus {
            outline: none;
            border-color: #9B59B6;
            box-shadow: 0 0 0 3px rgba(155,89,182,0.1);
        }
        button {
            background: linear-gradient(135deg, #5DADE2 0%, #9B59B6 100%);
            transition: all 0.2s;
        }
        button:hover {
            background: linear-gradient(135deg, #3498DB 0%, #8E44AD 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(93,173,226,0.4);
        }
    </style>
</head>
<body>
<div class="card">
    <h2 class="text-2xl font-semibold mb-3">Restablecer contraseña</h2>
    <p class="text-sm mb-4">Introduce tu nueva contraseña. El token debe estar presente en la URL.</p>
    <div>
        <label class="block text-sm font-medium">Nueva contraseña</label>
        <input id="newPassword" type="password" class="w-full mt-2 p-3 border rounded" placeholder="Nueva contraseña" />
        <div id="errNew" class="text-sm text-red-600 mt-2"></div>
    </div>
    <div class="mt-4">
        <label class="block text-sm font-medium">Confirmar contraseña</label>
        <input id="confirmPassword" type="password" class="w-full mt-2 p-3 border rounded" placeholder="Repite la contraseña" />
        <div id="errConfirm" class="text-sm text-red-600 mt-2"></div>
    </div>
    <div id="globalMsg" class="text-sm mt-4"></div>
        <div class="mt-6 flex gap-3">
        <button id="submitBtn" class="text-white px-4 py-2 rounded" style="background: linear-gradient(135deg, #5DADE2 0%, #9B59B6 100%); transition: all 0.2s; box-shadow: 0 4px 12px rgba(93,173,226,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(93,173,226,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(93,173,226,0.3)'">Actualizar contraseña</button>
        <a href="http://localhost:3000/index.html" class="px-4 py-2 rounded border">Volver</a>
    </div>
</div>

<script>
    function getTokenFromHash() {
        // Leer el token del hash (#) en lugar del query parameter (?)
        // Esto oculta el token de la barra de direcciones visible
        const hash = window.location.hash.substring(1); // Remover el #
        if (!hash) return null;
        const params = new URLSearchParams(hash);
        const value = params.get('token');
        // Decodificar el token si viene codificado
        return value ? decodeURIComponent(value) : null;
    }
    
    function getTokenFromQuery() {
        // Compatibilidad: también leer del query parameter si no está en el hash
        const params = new URLSearchParams(window.location.search);
        const value = params.get('token');
        return value ? decodeURIComponent(value) : null;
    }

    // Obtener el token del hash primero, luego del query parameter como fallback
    let token = getTokenFromHash() || getTokenFromQuery();
    
    // Limpiar la URL después de leer el token para que no se vea en la barra de direcciones
    if (token) {
        // Reemplazar la URL sin el hash ni el query parameter para ocultar el token
        window.history.replaceState(null, '', window.location.pathname);
    }
    const newPasswordEl = document.getElementById('newPassword');
    const confirmEl = document.getElementById('confirmPassword');
    const errNew = document.getElementById('errNew');
    const errConfirm = document.getElementById('errConfirm');
    const globalMsg = document.getElementById('globalMsg');
    const submitBtn = document.getElementById('submitBtn');

    function validPassword(pw) {
        return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/.test(pw);
    }

    // Validar que el token existe
    if (!token) {
        globalMsg.textContent = 'Token no encontrado en la URL. Usa el enlace enviado por email.';
        globalMsg.style.color = 'red';
        submitBtn.disabled = true;
        console.error('Token no encontrado en la URL:', window.location.search);
    } else {
        console.log('Token recibido correctamente:', token.substring(0, 20) + '...');
    }

    submitBtn.addEventListener('click', async () => {
        // Validar que el token existe antes de enviar
        if (!token) {
            globalMsg.textContent = 'Token no válido. Usa el enlace enviado por email.';
            globalMsg.style.color = 'red';
            return;
        }

        errNew.textContent = '';
        errConfirm.textContent = '';
        globalMsg.textContent = '';

        const pw = newPasswordEl.value;
        const pw2 = confirmEl.value;

        if (!pw || !validPassword(pw)) {
            errNew.textContent = 'Contraseña inválida. Mínimo 8 caracteres, mayúscula, minúscula y número.';
            return;
        }
        if (pw !== pw2) {
            errConfirm.textContent = 'Las contraseñas no coinciden.';
            return;
        }

        // Mostrar estado de carga
        submitBtn.disabled = true;
        submitBtn.textContent = 'Actualizando...';
        globalMsg.textContent = 'Procesando solicitud...';
        globalMsg.style.color = 'blue';

        try {
            const res = await fetch('http://localhost:3000/auth/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, newPassword: pw })
            });
            
            const data = await res.json();
            
            if (!res.ok) {
                globalMsg.textContent = data.message || 'Error al actualizar contraseña.';
                globalMsg.style.color = 'red';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Actualizar contraseña';
                return;
            }

            globalMsg.textContent = data.message || 'Contraseña actualizada exitosamente. Redirigiendo al login...';
            globalMsg.style.color = 'green';
            
            // Redirigir al login después de 1.5 segundos usando la URL completa del servidor
            setTimeout(() => {
                window.location.href = 'http://localhost:3000/index.html';
            }, 1500);
        } catch (err) {
            console.error('Error al resetear contraseña:', err);
            globalMsg.textContent = 'Error de red. Intenta nuevamente.';
            globalMsg.style.color = 'red';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Actualizar contraseña';
        }
    });
</script>
</body>
</html>
